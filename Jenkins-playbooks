pipeline {
    agent any

    triggers {
           cron('H/1 * * * *')  // Schedule to run every 5 minutes
     }


    environment {
        REMOTE_PATH = '/home/ec2-user/ansible_dev'
        ANSIBLE_SERVER = '67.202.35.1'
        SSH_CREDENTIALS = 'ansible-master-cred'
        BRANCH_NAME = 'main'
        PROJECT_URL = 'https://github.com/adoukpo/w17-ansible.git'
    }

    stages {
        stage('Git Checkout') {
            steps {
                git branch: "${BRANCH_NAME}", url: "${PROJECT_URL}"
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                sshagent(credentials: [SSH_CREDENTIALS]) {
                    script {
                        // Run the playbook on the remote server
                        sh """
                            ssh -o StrictHostKeyChecking=no ec2-user@${ANSIBLE_SERVER} "
                                cd ${REMOTE_PATH} &&
                                ansible-playbook -i inv.yml play.yml
                            "
                        """
                    }
                }
            }
        }
    }
}
